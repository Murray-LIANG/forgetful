<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>OpenStack Nova Detach Process Logs of Newton Version | Forgetful :/</title><meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="robots" content="noodp" />
<meta name="Description" content="Notes about everything"><link rel="prev" href="https://murray-liang.github.io/forgetful/2020/02/openstack-ospt-tips/" /><link rel="next" href="https://murray-liang.github.io/forgetful/2020/02/openstack-attach-logs/" /><link rel="canonical" href="https://murray-liang.github.io/forgetful/2020/02/openstack-detach-logs/" />
<link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff"><meta property="og:title" content="OpenStack Nova Detach Process Logs of Newton Version" />
<meta property="og:description" content="1. Get connector properties (219ms) 1 2 3 4 5 6 7  get_connector_properties: call { &#39;execute&#39;: None, &#39;my_ip&#39;: &#39;172.16.1.11&#39;, &#39;enforce_multipath&#39;: True, &#39;host&#39;: &#39;newton&#39;, &#39;root_helper&#39;: &#39;sudo nova-rootwrap /etc/nova/rootwrap.conf&#39;, &#39;multipath&#39;: True}   1.1 Check multipathd status, if multipath-tools is not installed or down, exception raises 1 2 3 4 5 6  $ multipathd show status path checker states: up 3 paths: 2 busy: False   1.2 Get the initiator name 1 2 3 4 5 6 7  $ cat /etc/iscsi/initiatorname." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://murray-liang.github.io/forgetful/2020/02/openstack-detach-logs/" />
<meta property="article:published_time" content="2020-02-10T16:37:31+08:00" />
<meta property="article:modified_time" content="2020-02-10T16:37:31+08:00" />
<script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "OpenStack Nova Detach Process Logs of Newton Version",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https:\/\/murray-liang.github.io\/forgetful\/2020\/02\/openstack-detach-logs\/"
        },"image": {
                "@type": "ImageObject",
                "url": "https:\/\/murray-liang.github.io\/forgetful\/cover.png",
                "width":  800 ,
                "height":  600 
            },"genre": "posts","keywords": "openstack, nova, cinder, detach","wordcount":  707 ,
        "url": "https:\/\/murray-liang.github.io\/forgetful\/2020\/02\/openstack-detach-logs\/","datePublished": "2020-02-10T16:37:31\x2b08:00","dateModified": "2020-02-10T16:37:31\x2b08:00","license": "This work is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License.","publisher": {
                "@type": "Organization",
                "name": "murray",
                "logo": {
                "@type": "ImageObject",
                "url": "https:\/\/murray-liang.github.io\/forgetful\/logo.png",
                "width":  127 ,
                "height":  40 
                }
            },"description": ""
    }
    </script><link rel="stylesheet" href="/forgetful/css/style.min.css"><link rel="stylesheet" href="/forgetful/css/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/forgetful/css/lib/forkawesome/forkawesome.min.css"><link rel="stylesheet" href="/forgetful/css/lib/animate/animate.min.css"></head>
    <body><script>
            if (!window.localStorage || !window.localStorage.getItem('theme')) {
                window.isDark = 'dark' === 'dark';
            } else {
                window.isDark = (window.localStorage && window.localStorage.getItem('theme')) === 'dark';
            }
            window.isDark && document.body.classList.add('dark-theme');
        </script><div class="wrapper"><nav class="navbar">
    <div class="navbar-container">
        <div class="navbar-header animated bounceIn">
            <a href="https://murray-liang.github.io/forgetful">Forgetful :/</a>
        </div>
        <div class="navbar-menu"><a class="menu-item" href="https://murray-liang.github.io/forgetful/posts" title="">Posts</a><a class="menu-item" href="https://murray-liang.github.io/forgetful/tags" title="">Tags</a><a class="menu-item" href="https://murray-liang.github.io/forgetful/categories" title="">Categories</a><a class="menu-item" href="https://murray-liang.github.io/forgetful/about" title="">About</a><a class="menu-item" href="https://github.com/Murray-LIANG/forgetful" title="简体中文"><i class="fas fa-language fa-fw"></i></a><a href="javascript:void(0);" class="theme-switch"><i class="fas fa-adjust fa-rotate-180 fa-fw" title="Switch Theme"></i></a>
        </div>
    </div>
</nav><nav class="navbar-mobile">
    <div class="navbar-container">
        <div class="navbar-header">
            <div class="navbar-header-title animated bounceIn">
                <a href="https://murray-liang.github.io/forgetful">Forgetful :/</a>
            </div>
            <div class="menu-toggle" id="menu-toggle">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="navbar-menu" id="mobile-menu"><a class="menu-item" href="https://murray-liang.github.io/forgetful/posts" title="">Posts</a><a class="menu-item" href="https://murray-liang.github.io/forgetful/tags" title="">Tags</a><a class="menu-item" href="https://murray-liang.github.io/forgetful/categories" title="">Categories</a><a class="menu-item" href="https://murray-liang.github.io/forgetful/about" title="">About</a><a class="menu-item" href="https://github.com/Murray-LIANG/forgetful" title="简体中文"></a><a href="javascript:void(0);" class="theme-switch"><i class="fas fa-adjust fa-rotate-180 fa-fw" title="Switch Theme"></i></a>
        </div>
    </div>
</nav>
<main class="main">
                <div class="container"><article class="page"><h1 class="post-title animated flipInX">OpenStack Nova Detach Process Logs of Newton Version</h1><div class="post-meta">
            <div class="post-meta-main"><a class="author" href="https://github.com/Murray-LIANG" rel="author" target="_blank">
                    <i class="fas fa-user-circle fa-fw"></i>Murray-LIANG
                </a>&nbsp;</div>
            <div class="post-meta-other"><i class="far fa-calendar-alt fa-fw"></i><time datetime=2020-02-10>2020-02-10</time>&nbsp;
                <i class="fas fa-pencil-alt fa-fw"></i>about 707 words&nbsp;
                <i class="far fa-clock fa-fw"></i>4 min&nbsp;</div>
        </div><div class="post-toc" id="post-toc">
                <h2 class="post-toc-title">Contents</h2>
                <div class="post-toc-content"><nav id="TableOfContents">
  <ul>
    <li><a href="#1-get-connector-properties-219ms">1. Get connector properties (219ms)</a>
      <ul>
        <li><a href="#11-check-multipathd-status-if-multipath-tools-is-not-installed-or-down-exception-raises">1.1 Check <code>multipathd</code> status, if <code>multipath-tools</code> is not installed or down, exception raises</a></li>
        <li><a href="#12-get-the-initiator-name">1.2 Get the initiator name</a></li>
        <li><a href="#13-get-the-fc-info">1.3 Get the fc info</a></li>
      </ul>
    </li>
    <li><a href="#2-detach-volume-from-vm">2. Detach volume from VM</a>
      <ul>
        <li><a href="#21-attempting-initial-detach-for-device-vdb-with-retry">2.1 Attempting initial detach for device <code>vdb</code> with retry</a></li>
      </ul>
    </li>
    <li><a href="#3-start-retrying-detach-until-device-vdb-is-gone">3. Start retrying detach until device <code>vdb</code> is gone</a></li>
    <li><a href="#4-calling-os-brick-to-detach-iscsi-volume-790ms">4. Calling os-brick to detach iSCSI volume (790ms)</a>
      <ul>
        <li><a href="#41-lock-connect_volume-acquired-by-os_brickinitiatorconnectorsiscsidisconnect_volume">4.1 Lock <code>connect_volume</code> acquired by <code>os_brick.initiator.connectors.iscsi.disconnect_volume</code></a></li>
        <li><a href="#42-rescan-multipath">4.2 Rescan multipath</a></li>
        <li><a href="#43-get-the-multipath-wwn">4.3 Get the multipath WWN</a></li>
        <li><a href="#44-remove-multipath-device-devsdd">4.4 Remove multipath device <code>/dev/sdd</code></a></li>
        <li><a href="#45-flush-multipath-device-36006016015e03a00ab2df25bb82d0ea9">4.5 Flush multipath device 36006016015e03a00ab2df25bb82d0ea9</a></li>
        <li><a href="#46-get-multipath-luns-to-remove">4.6 Get multipath LUNs to remove</a></li>
        <li><a href="#47-flushing-io-for-device-devsdd">4.7 Flushing IO for device <code>/dev/sdd</code></a></li>
        <li><a href="#48-remove-scsi-device-devsdd">4.8 Remove SCSI device <code>/dev/sdd</code></a></li>
        <li><a href="#49-flushing-io-for-device-devsdc">4.9 Flushing IO for device <code>/dev/sdc</code></a></li>
        <li><a href="#410-remove-scsi-device-devsdc">4.10 Remove SCSI device <code>/dev/sdc</code></a></li>
        <li><a href="#411-disconnect-multipath-device-devdiskby-iddm-uuid-mpath-36006016015e03a00ab2df25bb82d0ea9">4.11 Disconnect multipath device /dev/disk/by-id/dm-uuid-mpath-36006016015e03a00ab2df25bb82d0ea9</a></li>
        <li><a href="#412-lock-connect_volume-released-by-os_brickinitiatorconnectorsiscsidisconnect_volume">4.12 Lock <code>connect_volume</code> released by <code>os_brick.initiator.connectors.iscsi.disconnect_volume</code></a></li>
      </ul>
    </li>
    <li><a href="#5-post-call-to-cinder-action-os-terminate_connection">5. POST call to cinder, action <code>os-terminate_connection</code></a>
      <ul>
        <li><a href="#rest-request">REST request</a></li>
      </ul>
    </li>
    <li><a href="#6-post-call-to-cinder-action-os-detach">6. POST call to cinder, action <code>os-detach</code></a>
      <ul>
        <li><a href="#rest-request-1">REST request</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
            </div>
            <div class="post-toc-mobile" id="post-toc-mobile">
                <details>
                    <summary>
                        <div class="post-toc-title">
                            <span>Contents</span>
                            <span><i class="details icon fas fa-angle-down"></i></span>
                        </div>
                    </summary>
                    <div class="post-toc-content"><nav id="TableOfContentsMobile">
  <ul>
    <li><a href="#1-get-connector-properties-219ms">1. Get connector properties (219ms)</a>
      <ul>
        <li><a href="#11-check-multipathd-status-if-multipath-tools-is-not-installed-or-down-exception-raises">1.1 Check <code>multipathd</code> status, if <code>multipath-tools</code> is not installed or down, exception raises</a></li>
        <li><a href="#12-get-the-initiator-name">1.2 Get the initiator name</a></li>
        <li><a href="#13-get-the-fc-info">1.3 Get the fc info</a></li>
      </ul>
    </li>
    <li><a href="#2-detach-volume-from-vm">2. Detach volume from VM</a>
      <ul>
        <li><a href="#21-attempting-initial-detach-for-device-vdb-with-retry">2.1 Attempting initial detach for device <code>vdb</code> with retry</a></li>
      </ul>
    </li>
    <li><a href="#3-start-retrying-detach-until-device-vdb-is-gone">3. Start retrying detach until device <code>vdb</code> is gone</a></li>
    <li><a href="#4-calling-os-brick-to-detach-iscsi-volume-790ms">4. Calling os-brick to detach iSCSI volume (790ms)</a>
      <ul>
        <li><a href="#41-lock-connect_volume-acquired-by-os_brickinitiatorconnectorsiscsidisconnect_volume">4.1 Lock <code>connect_volume</code> acquired by <code>os_brick.initiator.connectors.iscsi.disconnect_volume</code></a></li>
        <li><a href="#42-rescan-multipath">4.2 Rescan multipath</a></li>
        <li><a href="#43-get-the-multipath-wwn">4.3 Get the multipath WWN</a></li>
        <li><a href="#44-remove-multipath-device-devsdd">4.4 Remove multipath device <code>/dev/sdd</code></a></li>
        <li><a href="#45-flush-multipath-device-36006016015e03a00ab2df25bb82d0ea9">4.5 Flush multipath device 36006016015e03a00ab2df25bb82d0ea9</a></li>
        <li><a href="#46-get-multipath-luns-to-remove">4.6 Get multipath LUNs to remove</a></li>
        <li><a href="#47-flushing-io-for-device-devsdd">4.7 Flushing IO for device <code>/dev/sdd</code></a></li>
        <li><a href="#48-remove-scsi-device-devsdd">4.8 Remove SCSI device <code>/dev/sdd</code></a></li>
        <li><a href="#49-flushing-io-for-device-devsdc">4.9 Flushing IO for device <code>/dev/sdc</code></a></li>
        <li><a href="#410-remove-scsi-device-devsdc">4.10 Remove SCSI device <code>/dev/sdc</code></a></li>
        <li><a href="#411-disconnect-multipath-device-devdiskby-iddm-uuid-mpath-36006016015e03a00ab2df25bb82d0ea9">4.11 Disconnect multipath device /dev/disk/by-id/dm-uuid-mpath-36006016015e03a00ab2df25bb82d0ea9</a></li>
        <li><a href="#412-lock-connect_volume-released-by-os_brickinitiatorconnectorsiscsidisconnect_volume">4.12 Lock <code>connect_volume</code> released by <code>os_brick.initiator.connectors.iscsi.disconnect_volume</code></a></li>
      </ul>
    </li>
    <li><a href="#5-post-call-to-cinder-action-os-terminate_connection">5. POST call to cinder, action <code>os-terminate_connection</code></a>
      <ul>
        <li><a href="#rest-request">REST request</a></li>
      </ul>
    </li>
    <li><a href="#6-post-call-to-cinder-action-os-detach">6. POST call to cinder, action <code>os-detach</code></a>
      <ul>
        <li><a href="#rest-request-1">REST request</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
                </details>
            </div><div class="post-content"><a class="post-dummy-target" id="1-get-connector-properties-219ms"></a><h2>1. Get connector properties (219ms)</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">get_connector_properties: call <span class="o">{</span>
    <span class="s1">&#39;execute&#39;</span>: None,
    <span class="s1">&#39;my_ip&#39;</span>: <span class="s1">&#39;172.16.1.11&#39;</span>,
    <span class="s1">&#39;enforce_multipath&#39;</span>: True,
    <span class="s1">&#39;host&#39;</span>: <span class="s1">&#39;newton&#39;</span>,
    <span class="s1">&#39;root_helper&#39;</span>: <span class="s1">&#39;sudo nova-rootwrap /etc/nova/rootwrap.conf&#39;</span>,
    <span class="s1">&#39;multipath&#39;</span>: True<span class="o">}</span>
</code></pre></td></tr></table>
</div>
</div><a class="post-dummy-target" id="11-check-multipathd-status-if-multipath-tools-is-not-installed-or-down-exception-raises"></a><h3>1.1 Check <code>multipathd</code> status, if <code>multipath-tools</code> is not installed or down, exception raises</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">$ multipathd show status
path checker states:
up                  <span class="m">3</span>

paths: <span class="m">2</span>
busy: False
</code></pre></td></tr></table>
</div>
</div><a class="post-dummy-target" id="12-get-the-initiator-name"></a><h3>1.2 Get the initiator name</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">$ cat /etc/iscsi/initiatorname.iscsi
<span class="c1">## DO NOT EDIT OR REMOVE THIS FILE!</span>
<span class="c1">## If you remove this file, the iSCSI daemon will not start.</span>
<span class="c1">## If you change the InitiatorName, existing access control lists</span>
<span class="c1">## may reject this initiator.  The InitiatorName must be unique</span>
<span class="c1">## for each iSCSI initiator.  Do NOT duplicate iSCSI InitiatorNames.</span>
<span class="nv">InitiatorName</span><span class="o">=</span>iqn.1993-08.org.debian:01:7cc8838d1c0
</code></pre></td></tr></table>
</div>
</div><a class="post-dummy-target" id="13-get-the-fc-info"></a><h3>1.3 Get the fc info</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">systool -c fc_host -v
Error opening class fc_host
</code></pre></td></tr></table>
</div>
</div><a class="post-dummy-target" id="2-detach-volume-from-vm"></a><h2>2. Detach volume from VM</h2>
<p>Detach volume 5ed0cc5c-158c-4857-9bd5-3556884a23f0 from mountpoint /dev/vdb</p>
<a class="post-dummy-target" id="21-attempting-initial-detach-for-device-vdb-with-retry"></a><h3>2.1 Attempting initial detach for device <code>vdb</code> with retry</h3>
<p>The xml used by <code>libvirt</code> to detach device from VM</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-xml" data-lang="xml"><span class="nt">&lt;disk</span> <span class="na">type=</span><span class="s">&#34;block&#34;</span> <span class="na">device=</span><span class="s">&#34;disk&#34;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;driver</span> <span class="na">name=</span><span class="s">&#34;qemu&#34;</span> <span class="na">type=</span><span class="s">&#34;raw&#34;</span> <span class="na">cache=</span><span class="s">&#34;none&#34;</span> <span class="na">io=</span><span class="s">&#34;native&#34;</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;source</span> <span class="na">dev=</span><span class="s">&#34;/dev/disk/by-id/dm-uuid-mpath-36006016015e03a00ab2df25bb82d0ea9&#34;</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;target</span> <span class="na">bus=</span><span class="s">&#34;virtio&#34;</span> <span class="na">dev=</span><span class="s">&#34;vdb&#34;</span><span class="nt">/&gt;</span>
  <span class="nt">&lt;serial&gt;</span>5ed0cc5c-158c-4857-9bd5-3556884a23f0<span class="nt">&lt;/serial&gt;</span>
<span class="nt">&lt;/disk&gt;</span>
</code></pre></td></tr></table>
</div>
</div><a class="post-dummy-target" id="3-start-retrying-detach-until-device-vdb-is-gone"></a><h2>3. Start retrying detach until device <code>vdb</code> is gone</h2>
<a class="post-dummy-target" id="4-calling-os-brick-to-detach-iscsi-volume-790ms"></a><h2>4. Calling os-brick to detach iSCSI volume (790ms)</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-python" data-lang="python"><span class="n">disconnect_volume</span><span class="p">:</span> <span class="n">call</span> <span class="p">{</span>
    <span class="s1">&#39;args&#39;</span><span class="p">:</span> <span class="p">(</span>
        <span class="o">&lt;</span><span class="n">os_brick</span><span class="o">.</span><span class="n">initiator</span><span class="o">.</span><span class="n">connectors</span><span class="o">.</span><span class="n">iscsi</span><span class="o">.</span><span class="n">ISCSIConnector</span> <span class="nb">object</span> <span class="n">at</span> <span class="mh">0x7fe51cd174d0</span><span class="o">&gt;</span><span class="p">,</span>
        <span class="p">{</span>
            <span class="sa">u</span><span class="s1">&#39;target_luns&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">197</span><span class="p">,</span> <span class="mi">197</span><span class="p">],</span>
            <span class="sa">u</span><span class="s1">&#39;target_iqns&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="sa">u</span><span class="s1">&#39;iqn.1992-04.com.emc:cx.fnm00150600267.a0&#39;</span><span class="p">,</span>
                <span class="sa">u</span><span class="s1">&#39;iqn.1992-04.com.emc:cx.fnm00150600267.b0&#39;</span> <span class="p">],</span>
            <span class="sa">u</span><span class="s1">&#39;device_path&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;/dev/disk/by-id/dm-uuid-mpath-36006016015e03a00ab2df25bb82d0ea9&#39;</span><span class="p">,</span>
            <span class="sa">u</span><span class="s1">&#39;target_discovered&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
            <span class="sa">u</span><span class="s1">&#39;encrypted&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">,</span>
            <span class="sa">u</span><span class="s1">&#39;qos_specs&#39;</span><span class="p">:</span> <span class="bp">None</span><span class="p">,</span>
            <span class="sa">u</span><span class="s1">&#39;target_iqn&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;iqn.1992-04.com.emc:cx.fnm00150600267.a0&#39;</span><span class="p">,</span>
            <span class="sa">u</span><span class="s1">&#39;target_portals&#39;</span><span class="p">:</span> <span class="p">[</span><span class="sa">u</span><span class="s1">&#39;10.245.47.95: 3260&#39;</span><span class="p">,</span> <span class="sa">u</span><span class="s1">&#39;10.245.47.96: 3260&#39;</span><span class="p">],</span>
            <span class="sa">u</span><span class="s1">&#39;volume_id&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;5ed0cc5c-158c-4857-9bd5-3556884a23f0&#39;</span><span class="p">,</span> 
            <span class="sa">u</span><span class="s1">&#39;target_lun&#39;</span><span class="p">:</span> <span class="mi">197</span><span class="p">,</span>
            <span class="sa">u</span><span class="s1">&#39;access_mode&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;rw&#39;</span><span class="p">,</span>
            <span class="sa">u</span><span class="s1">&#39;target_portal&#39;</span><span class="p">:</span> <span class="sa">u</span><span class="s1">&#39;10.245.47.95: 3260&#39;</span>
        <span class="p">},</span>
        <span class="bp">None</span><span class="p">),</span>
    <span class="s1">&#39;kwargs&#39;</span><span class="p">:</span> <span class="p">{}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><a class="post-dummy-target" id="41-lock-connect_volume-acquired-by-os_brickinitiatorconnectorsiscsidisconnect_volume"></a><h3>4.1 Lock <code>connect_volume</code> acquired by <code>os_brick.initiator.connectors.iscsi.disconnect_volume</code></h3>
<a class="post-dummy-target" id="42-rescan-multipath"></a><h3>4.2 Rescan multipath</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">$ multipath -r
reload: 36006016015e03a00ab2df25bb82d0ea9 undef DGC,VRAID
<span class="nv">size</span><span class="o">=</span>3.0G <span class="nv">features</span><span class="o">=</span><span class="s1">&#39;1 queue_if_no_path&#39;</span> <span class="nv">hwhandler</span><span class="o">=</span><span class="s1">&#39;1 emc&#39;</span> <span class="nv">wp</span><span class="o">=</span>undef
<span class="p">|</span>-+- <span class="nv">policy</span><span class="o">=</span><span class="s1">&#39;round-robin 0&#39;</span> <span class="nv">prio</span><span class="o">=</span><span class="m">50</span> <span class="nv">status</span><span class="o">=</span>undef
<span class="p">|</span> <span class="sb">`</span>- 2:0:0:197 sdd 8:48 active ready running
<span class="sb">`</span>-+- <span class="nv">policy</span><span class="o">=</span><span class="s1">&#39;round-robin 0&#39;</span> <span class="nv">prio</span><span class="o">=</span><span class="m">10</span> <span class="nv">status</span><span class="o">=</span>undef
  <span class="sb">`</span>- 3:0:0:197 sdc 8:32 active ready running
</code></pre></td></tr></table>
</div>
</div><a class="post-dummy-target" id="43-get-the-multipath-wwn"></a><h3>4.3 Get the multipath WWN</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">$ /lib/udev/scsi_id --page 0x83 --whitelisted /dev/disk/by-path/ip-10.245.47.95:3260-iscsi-iqn.1992-04.com.emc:cx.fnm00150600267.a0-lun-197
36006016015e03a00ab2df25bb82d0ea9

<span class="c1"># Find Multipath device file for volume WWN 36006016015e03a00ab2df25bb82d0ea9</span>

<span class="c1"># Checking to see if /dev/disk/by-id/dm-uuid-mpath-36006016015e03a00ab2df25bb82d0ea9 exists yet.</span>

<span class="c1"># /dev/disk/by-id/dm-uuid-mpath-36006016015e03a00ab2df25bb82d0ea9 has shown up.</span>

<span class="c1"># Checking to see if /dev/disk/by-id/dm-uuid-mpath-36006016015e03a00ab2df25bb82d0ea9 is read-only.</span>

$ lsblk -o NAME,RO -l -n
sdc                                <span class="m">0</span>
36006016015e03a00ab2df25bb82d0ea9  <span class="m">0</span>
sdd                                <span class="m">0</span>
36006016015e03a00ab2df25bb82d0ea9  <span class="m">0</span>
sdf                                <span class="m">0</span>
vda                                <span class="m">0</span>
vda1                               <span class="m">0</span>
loop0                              <span class="m">0</span>

<span class="c1"># Block device /dev/disk/by-id/dm-uuid-mpath-36006016015e03a00ab2df25bb82d0ea9 is not read-only.</span>

</code></pre></td></tr></table>
</div>
</div><a class="post-dummy-target" id="44-remove-multipath-device-devsdd"></a><h3>4.4 Remove multipath device <code>/dev/sdd</code></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">$ multipath -l /dev/sdd
36006016015e03a00ab2df25bb82d0ea9 dm-0 DGC,VRAID
<span class="nv">size</span><span class="o">=</span>3.0G <span class="nv">features</span><span class="o">=</span><span class="s1">&#39;2 queue_if_no_path retain_attached_hw_handler&#39;</span> <span class="nv">hwhandler</span><span class="o">=</span><span class="s1">&#39;1 emc&#39;</span> <span class="nv">wp</span><span class="o">=</span>rw
<span class="p">|</span>-+- <span class="nv">policy</span><span class="o">=</span><span class="s1">&#39;round-robin 0&#39;</span> <span class="nv">prio</span><span class="o">=</span><span class="m">0</span> <span class="nv">status</span><span class="o">=</span>active
<span class="p">|</span> <span class="sb">`</span>- 2:0:0:197 sdd 8:48 active undef running
<span class="sb">`</span>-+- <span class="nv">policy</span><span class="o">=</span><span class="s1">&#39;round-robin 0&#39;</span> <span class="nv">prio</span><span class="o">=</span><span class="m">0</span> <span class="nv">status</span><span class="o">=</span>enabled
  <span class="sb">`</span>- 3:0:0:197 sdc 8:32 active undef running

<span class="c1"># Found multipath device = /dev/mapper/36006016015e03a00ab2df25bb82d0ea9</span>
</code></pre></td></tr></table>
</div>
</div><a class="post-dummy-target" id="45-flush-multipath-device-36006016015e03a00ab2df25bb82d0ea9"></a><h3>4.5 Flush multipath device 36006016015e03a00ab2df25bb82d0ea9</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">$ multipath -f 36006016015e03a00ab2df25bb82d0ea9

</code></pre></td></tr></table>
</div>
</div><a class="post-dummy-target" id="46-get-multipath-luns-to-remove"></a><h3>4.6 Get multipath LUNs to remove</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">multipath LUNs to remove 
<span class="o">[</span>
    <span class="o">{</span><span class="s1">&#39;device&#39;</span>: u<span class="s1">&#39;/dev/sdd&#39;</span>,
     <span class="s1">&#39;host&#39;</span>: u<span class="s1">&#39;2&#39;</span>,
     <span class="s1">&#39;id&#39;</span>: u<span class="s1">&#39;0&#39;</span>,
     <span class="s1">&#39;channel&#39;</span>: u<span class="s1">&#39;0&#39;</span>,
     <span class="s1">&#39;lun&#39;</span>: u<span class="s1">&#39;197&#39;</span><span class="o">}</span>,
    <span class="o">{</span><span class="s1">&#39;device&#39;</span>: u<span class="s1">&#39;/dev/sdc&#39;</span>,
     <span class="s1">&#39;host&#39;</span>: u<span class="s1">&#39;3&#39;</span>, 
     <span class="s1">&#39;id&#39;</span>: u<span class="s1">&#39;0&#39;</span>, 
     <span class="s1">&#39;channel&#39;</span>: u<span class="s1">&#39;0&#39;</span>, 
     <span class="s1">&#39;lun&#39;</span>: u<span class="s1">&#39;197&#39;</span><span class="o">}]</span>
</code></pre></td></tr></table>
</div>
</div><a class="post-dummy-target" id="47-flushing-io-for-device-devsdd"></a><h3>4.7 Flushing IO for device <code>/dev/sdd</code></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">$ blockdev --flushbufs /dev/sdd
</code></pre></td></tr></table>
</div>
</div><a class="post-dummy-target" id="48-remove-scsi-device-devsdd"></a><h3>4.8 Remove SCSI device <code>/dev/sdd</code></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">$ tee -a /sys/block/sdd/device/delete
</code></pre></td></tr></table>
</div>
</div><a class="post-dummy-target" id="49-flushing-io-for-device-devsdc"></a><h3>4.9 Flushing IO for device <code>/dev/sdc</code></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">$ blockdev --flushbufs /dev/sdc
</code></pre></td></tr></table>
</div>
</div><a class="post-dummy-target" id="410-remove-scsi-device-devsdc"></a><h3>4.10 Remove SCSI device <code>/dev/sdc</code></h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">$ tee -a /sys/block/sdc/device/delete
</code></pre></td></tr></table>
</div>
</div><a class="post-dummy-target" id="411-disconnect-multipath-device-devdiskby-iddm-uuid-mpath-36006016015e03a00ab2df25bb82d0ea9"></a><h3>4.11 Disconnect multipath device /dev/disk/by-id/dm-uuid-mpath-36006016015e03a00ab2df25bb82d0ea9</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">$ multipath -ll
<span class="c1"># no output</span>

$ multipath -r
<span class="c1"># no output</span>
</code></pre></td></tr></table>
</div>
</div><a class="post-dummy-target" id="412-lock-connect_volume-released-by-os_brickinitiatorconnectorsiscsidisconnect_volume"></a><h3>4.12 Lock <code>connect_volume</code> released by <code>os_brick.initiator.connectors.iscsi.disconnect_volume</code></h3>
<p>Held <strong>0.790s</strong></p>
<a class="post-dummy-target" id="5-post-call-to-cinder-action-os-terminate_connection"></a><h2>5. POST call to cinder, action <code>os-terminate_connection</code></h2>
<a class="post-dummy-target" id="rest-request"></a><h3>REST request</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">$ curl -g -i -X POST <span class="se">\
</span><span class="se"></span>    http://172.16.1.11:8776/v2/ca2fbd57936b45bf9abdb536dc152a6d/volumes/5ed0cc5c-158c-4857-9bd5-3556884a23f0/action <span class="se">\
</span><span class="se"></span>    -H <span class="s2">&#34;User-Agent: python-cinderclient&#34;</span> -H <span class="s2">&#34;Content-Type: application/json&#34;</span> <span class="se">\
</span><span class="se"></span>    -H <span class="s2">&#34;Accept: application/json&#34;</span> -H <span class="s2">&#34;X-Auth-Token: {SHA1}deea2e5c2c82807813e48cc3ce629c6ad98c9a7a&#34;</span> <span class="se">\
</span><span class="se"></span>    -d <span class="s1">&#39;{&#34;os-terminate_connection&#34;: {&#34;connector&#34;: {&#34;platform&#34;: &#34;x86_64&#34;, &#34;host&#34;: &#34;newton&#34;, &#34;do_local_attach&#34;: false, &#34;ip&#34;: &#34;172.16.1.11&#34;, &#34;os_type&#34;: &#34;linux2&#34;, &#34;multipath&#34;: true, &#34;initiator&#34;: &#34;iqn.1993-08.org.debian:01:7cc8838d1c0&#34;}}}&#39;</span>
</code></pre></td></tr></table>
</div>
</div><a class="post-dummy-target" id="6-post-call-to-cinder-action-os-detach"></a><h2>6. POST call to cinder, action <code>os-detach</code></h2>
<a class="post-dummy-target" id="rest-request-1"></a><h3>REST request</h3>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-bash" data-lang="bash">$ curl -g -i -X POST <span class="se">\
</span><span class="se"></span>    http://172.16.1.11:8776/v2/ca2fbd57936b45bf9abdb536dc152a6d/volumes/5ed0cc5c-158c-4857-9bd5-3556884a23f0/action <span class="se">\
</span><span class="se"></span>    -H <span class="s2">&#34;User-Agent: python-cinderclient&#34;</span> -H <span class="s2">&#34;Content-Type: application/json&#34;</span> <span class="se">\
</span><span class="se"></span>    -H <span class="s2">&#34;Accept: application/json&#34;</span> -H <span class="s2">&#34;X-Auth-Token: {SHA1}deea2e5c2c82807813e48cc3ce629c6ad98c9a7a&#34;</span> <span class="se">\
</span><span class="se"></span>    -d <span class="s1">&#39;{&#34;os-detach&#34;: {&#34;attachment_id&#34;: &#34;c0e36b23-5be9-49af-b1fb-f6635e5c186e&#34;}}&#39;</span>
</code></pre></td></tr></table>
</div>
</div></div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>The article was updated on 2020-02-10</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share"><span></span></div>
        </div>
    </div>

    <div class="post-info-more">
        <section><span class="tag">
                        <a href="https://murray-liang.github.io/forgetful/tags/openstack/"><i class="fas fa-tag fa-fw"></i>&nbsp;openstack</a>&nbsp;
                    </span><span class="tag">
                        <a href="https://murray-liang.github.io/forgetful/tags/nova/"><i class="fas fa-tag fa-fw"></i>&nbsp;nova</a>&nbsp;
                    </span><span class="tag">
                        <a href="https://murray-liang.github.io/forgetful/tags/cinder/"><i class="fas fa-tag fa-fw"></i>&nbsp;cinder</a>&nbsp;
                    </span><span class="tag">
                        <a href="https://murray-liang.github.io/forgetful/tags/detach/"><i class="fas fa-tag fa-fw"></i>&nbsp;detach</a>&nbsp;
                    </span></section>
        <section>
            <span><a href="javascript:window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="https://murray-liang.github.io/forgetful">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="https://murray-liang.github.io/forgetful/2020/02/openstack-ospt-tips/" class="prev" rel="prev" title="OpenStack ospt Tips"><i class="fas fa-angle-left fa-fw"></i>OpenStack ospt Tips</a>
            <a href="https://murray-liang.github.io/forgetful/2020/02/openstack-attach-logs/" class="next" rel="next" title="OpenStack Nova Attach Process Logs of Newton Version">OpenStack Nova Attach Process Logs of Newton Version<i class="fas fa-angle-right fa-fw"></i></a></div>
</div>
<div class="post-comment"></div>
    </article></div>
            </main><footer class="footer">
    <div class="copyright"><div class="copyright-line">Powered by <a href="https://gohugo.io/" target="_blank" rel="external nofollow noopener noreffer">Hugo</a> | Theme - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="external nofollow noopener noreffer">LoveIt<i class="far fa-heart fa-fw"></i></a>
        </div>

        <div class="copyright-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2020</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="https://github.com/Murray-LIANG" target="_blank">Murray-LIANG</a></span>&nbsp;|&nbsp;<span class="license"><a rel="license external nofollow noopener noreffer" href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank">CC BY-NC 4.0</a></span></div>
    </div>
</footer>
</div><a href="#" class="dynamic-to-top" id="dynamic-to-top" data-scroll>
            <span>&nbsp;</span>
        </a><script src="/forgetful/js/lib/jquery/jquery.slim.min.js"></script><script src="/forgetful/js/lib/lazysizes/lazysizes.min.js"></script><script src="/forgetful/js/lib/smooth-scroll/smooth-scroll.polyfills.min.js"></script><script>window.scroll = new SmoothScroll('[data-scroll]', {speed: 300, speedAsDuration: true});</script><link rel="stylesheet" href="/forgetful/css/lib/katex/katex.min.css"><script src="/forgetful/js/lib/katex/katex.min.js"></script><script defer src="/forgetful/js/lib/katex/auto-render.min.js"></script><link rel="stylesheet" href="/forgetful/css/lib/katex/copy-tex.min.css"><script defer src="/forgetful/js/lib/katex/copy-tex.min.js"></script><script defer src="/forgetful/js/lib/katex/mhchem.min.js"></script><script>
        document.addEventListener("DOMContentLoaded", function () {
            renderMathInElement(document.body, {
                delimiters: [
                    { left: "$$", right: "$$", display: true },
                    { left: "\\(", right: "\\)", display: false },
                    { left: "\\[", right: "\\]", display: true },{ left: "$", right: "$", display: false },]
            });
        });
    </script><script src="/forgetful/js/blog.min.js"></script>
</body>
</html>
